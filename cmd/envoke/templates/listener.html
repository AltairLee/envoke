{{define "head"}}
  <title>{{ .Title}}</title>
  <script type="text/javascript" src="/static/jplayer/jquery.min.js"></script>
  <script type="text/javascript" src="/static/jplayer/jquery.jplayer.min.js"></script>
  <script type="text/javascript" src="/static/jplayer/jplayer.playlist.min.js"></script>
{{end}}

{{define "body"}}
<!-- Form -->
<div id="stream-track">
    <form id="stream-track-form">
        <h2>Stream track</h2>
        <!-- should be logged in -->
        <!--<input type="text" name="track_id" placeholder="track id" required /><br>-->
        <input type="text" name="track_title" placeholder="track title" required /><br>
        <input type="text" name="project_title" placeholder="project title" required /><br>
        <input type="submit" value="stream" />
    </form>
</div>
<!-- Media Player -->
<div id="jplayer_container" class="jp-video jp-video-270p" role="application" aria-label="media player">
  <div class="jp-type-playlist">
    <div id="jplayer" class="jp-jplayer"></div>
    <div class="jp-gui">
      <div class="jp-video-play">
        <button class="jp-video-play-icon" role="button" tabindex="0">play</button>
      </div>
      <div class="jp-interface">
        <div class="jp-progress">
          <div class="jp-seek-bar">
            <div class="jp-play-bar"></div>
          </div>
        </div>
        <div class="jp-current-time" role="timer" aria-label="time">&nbsp;</div>
        <div class="jp-duration" role="timer" aria-label="duration">&nbsp;</div>
        <div class="jp-details">
          <div class="jp-title" aria-label="title">&nbsp;</div>
        </div>
        <div class="jp-controls-holder">
          <div class="jp-volume-controls">
            <button class="jp-mute" role="button" tabindex="0">mute</button>
            <button class="jp-volume-max" role="button" tabindex="0">max volume</button>
            <div class="jp-volume-bar">
              <div class="jp-volume-bar-value"></div>
            </div>
          </div>
          <div class="jp-controls">
            <button class="jp-previous" role="button" tabindex="0">previous</button>
            <button class="jp-play" role="button" tabindex="0">play</button>
            <button class="jp-stop" role="button" tabindex="0">stop</button>
            <button class="jp-next" role="button" tabindex="0">next</button>
          </div>
          <div class="jp-toggles">
            <button class="jp-repeat" role="button" tabindex="0">repeat</button>
            <button class="jp-shuffle" role="button" tabindex="0">shuffle</button>
            <button class="jp-full-screen" role="button" tabindex="0">full screen</button>
          </div>
        </div>
      </div>
    </div>
    <div class="jp-playlist">
      <ul>
        <li></li>
      </ul>
    </div>
    <div class="jp-no-solution">
      <span>Update Required</span>
      To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
    </div>
  </div>
</div>
<script type="text/javascript">
  function httpPostAsync(addr, data, callback) {
      var xhr = new XMLHttpRequest ();
      xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
          if (xhr.status == 200) {
            callback(xhr.responseText);
          } else {
            alert(xhr.responseText);
          };
        };
      };
      xhr.open("POST", addr, true); 
      xhr.send(data);
  };
  var streamTrackCallback = function(responseText) {
    var json = JSON.parse(responseText);
    console.log(json);
    var tracks = [];
    tracks.push({
      title: json["track_title"],
      artist: "",
      mp3: json["url"],
    })
    var jplayer = new jPlayerPlaylist({
      jPlayer:'#jplayer',
      cssSelectorAncestor: '#jplayer_container'}, tracks, {
      swfPath: "static/jplayer",
      solution: "flash, html",
      supplied: "mp3",
      useStateClassSkin: true,
      autoBlur: false,
      smoothPlayBar: true,
      keyEnabled: true,
      audioFullScreen: true,
      ready: function(event) {
        var $player = $(this)
        $player.jPlayer("play")
      },
    });
  };
  window.onload = function() {
    // Stream track
    var streamTrackForm = document.getElementById("stream-track-form");
    streamTrackForm.onsubmit = function(event) {
      event.preventDefault();
      var formData = $("#stream-track-form").serialize();
      httpPostAsync("http://localhost:8888/stream_track", formData, streamTrackCallback);
    };
  };
</script>
{{end}}